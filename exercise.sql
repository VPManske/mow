CREATE TABLE P_AVG (30SecAVG Decimal(40,20), BUCKET datetime, PCTCHG decimal(10,5), id MEDIUMINT NOT NULL AUTO_INCREMENT, PRIMARY KEY (id));

INSERT INTO P_AVG (30SecAVG, BUCKET) SELECT AVG(Price) AS 30SecAVG, CASE WHEN SECOND(time) < 30 THEN TIMESTAMP(CONCAT(YEAR(time) ,":",LPAD(MONTH(time),2,'0'),":",LPAD(DAY(time),2,'0'),":",LPAD(HOUR(time), 2,'0'),":",LPAD(MINUTE(time),2,'0')) ) WHEN SECOND(time) >= 30 THEN  TIMESTAMP(CONCAT(YEAR(time) ,":",LPAD(MONTH(time),2,'0'),":",LPAD(DAY(time),2,'0'),":",LPAD(HOUR(time), 2,'0'),":",LPAD(MINUTE(time),2,'0'),":30") ) END AS BUCKET  FROM BTCE_TRADES WHERE time >= TIMESTAMP("2017-01-30") AND PAIR = "btc_usd" GROUP BY CASE WHEN SECOND(time) < 30 THEN TIMESTAMP(CONCAT(YEAR(time) ,":",LPAD(MONTH(time),2,'0'),":",LPAD(DAY(time),2,'0'),":",LPAD(HOUR(time), 2,'0'),":",LPAD(MINUTE(time),2,'0')) ) WHEN SECOND(time) >= 30 THEN  TIMESTAMP(CONCAT(YEAR(time) ,":",LPAD(MONTH(time),2,'0'),":",LPAD(DAY(time),2,'0'),":",LPAD(HOUR(time), 2,'0'),":",LPAD(MINUTE(time),2,'0'),":30") ) END ;
UPDATE P_AVG A JOIN P_AVG B ON A.id=B.id+1 SET A.PCTCHG = ((A.30SecAVG-B.30SECAVG)/B.30SECAVG)*100;

